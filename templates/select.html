{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Select an Activity to Analyze{% if athlete_name %} - {{ athlete_name }}{% endif %}</h2>
    {% if athlete_name %}
        <a href="{{ url_for('athlete_profile', athlete_name=athlete_name) }}" class="btn btn-secondary">Back to Profile</a>
    {% else %}
        <a href="{{ url_for('athletes') }}" class="btn btn-secondary">Back to Athletes</a>
    {% endif %}
</div>
<form method="post" action="{{ url_for('select_activity') }}" id="select-activity-form">
    <ul class="list-group mb-3">
        {% for act in activities %}
        <li class="list-group-item" id="activity-{{ act.id }}">
            <div class="d-flex justify-content-between align-items-center">
                <span>{{ act.name }} ({{ act.type }}, {{ act.distance_miles }} mi, {{ act.pace_min_per_mile }} min/mi)</span>
                <button type="button" class="btn btn-outline-primary btn-sm analyze-btn" data-activity-id="{{ act.id }}" data-activity-name="{{ act.name|e }}" onclick="showModeModal(this)">Analyze</button>
            </div>
            <div id="loading-{{ act.id }}" class="mt-2 text-center" style="display:none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <small class="ms-2">Fetching detailed data and analyzing with OpenAI...</small>
            </div>
            <div id="analysis-{{ act.id }}" class="mt-3 p-3 bg-light border rounded" style="display:none;">
                <h6>Analysis Results:</h6>
                <div id="analysis-content-{{ act.id }}"></div>
            </div>
        </li>
        {% endfor %}
    </ul>
    <div class="mb-3">
        <label for="analysis_query" class="form-label">What do you want to analyze? (optional)</label>
        <input type="text" class="form-control" id="analysis_query" name="analysis_query" value="{{ analysis_query or '' }}" placeholder="e.g. performance, heart rate, calories">
    </div>
    <button type="submit" class="btn btn-info" name="summarize" value="1">Summarize Activities</button>
</form>
{% if summary %}
<h4 class="mt-4">Weekly Activity Summary</h4>
<table class="table table-bordered" id="summary-table">
    <thead>
        <tr>
            <th>Week Starting</th>
            {% for t in summary.activity_types %}
            <th>{{ t }}</th>
            {% endfor %}
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        {% for row in summary.rows %}
        <tr>
            <td>{{ row.week }}</td>
            {% for t in summary.activity_types %}
            <td>{{ row[t] }}</td>
            {% endfor %}
            <td>{{ row.total }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="mt-3">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
    <button class="btn btn-primary ms-2" onclick="downloadSummaryCSV(); return false;">Download CSV</button>
</div>
<script>
function downloadSummaryCSV() {
    var table = document.getElementById('summary-table');
    var rows = table.querySelectorAll('tr');
    var csv = [];
    for (var i = 0; i < rows.length; i++) {
        var cols = rows[i].querySelectorAll('th,td');
        var row = [];
        for (var j = 0; j < cols.length; j++) {
            row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
        }
        csv.push(row.join(','));
    }
    var csvContent = csv.join('\n');
    var blob = new Blob([csvContent], { type: 'text/csv' });
    var link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = 'strava_summary.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endif %}
<!-- Modal for selecting analysis mode -->
<div class="modal fade" id="modeModal" tabindex="-1" aria-labelledby="modeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modeModalLabel">Select Analysis Mode</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="modal-activity-name" class="mb-3 fw-bold"></p>

        <!-- Training Intent Selection -->
        <div class="mb-4">
          <label for="training-intent" class="form-label fw-bold">Training Intent:</label>
          <select class="form-select" id="training-intent">
            <option value="aerobic base">Aerobic Base</option>
            <option value="long run">Long Run</option>
            <option value="race simulation">Race Simulation</option>
            <option value="recovery">Recovery</option>
            <option value="threshold">Threshold</option>
          </select>
        </div>

        <!-- Analysis Mode Selection -->
        <div class="d-grid gap-3">
          <button type="button" class="btn btn-outline-secondary btn-lg text-start" onclick="runAnalysis('nerd')">
            <div class="fw-bold">Nerd Mode ðŸ¤“</div>
            <small class="text-muted">Data-driven, quantitative analysis - let the numbers speak</small>
          </button>
          <button type="button" class="btn btn-outline-danger btn-lg text-start" onclick="runAnalysis('maniac')">
            <div class="fw-bold">Maniac Mode ðŸ”¥</div>
            <small class="text-muted">Brutal honesty, no excuses - elite athlete standards</small>
          </button>
          <button type="button" class="btn btn-outline-success btn-lg text-start" onclick="runAnalysis('nice')">
            <div class="fw-bold">Nice Coach Mode ðŸ˜Š</div>
            <small class="text-muted">Supportive and encouraging - sustainable improvement</small>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  var currentActivityId = null;

  function showModeModal(button) {
    // Get activity ID and name from button data attributes
    currentActivityId = button.dataset.activityId;
    var activityName = button.dataset.activityName;

    // Update modal title
    document.getElementById('modal-activity-name').textContent = activityName;

    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById('modeModal'));
    modal.show();
  }

  function runAnalysis(mode) {
    // Get selected training intent
    var trainingIntent = document.getElementById('training-intent').value;

    // Hide the modal
    var modal = bootstrap.Modal.getInstance(document.getElementById('modeModal'));
    modal.hide();

    // Show loading spinner
    document.getElementById('loading-' + currentActivityId).style.display = 'block';
    // Hide analysis if previously shown
    document.getElementById('analysis-' + currentActivityId).style.display = 'none';

    // Make AJAX request to analyze endpoint
    fetch('/api/analyze_activity/' + currentActivityId, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        mode: mode,
        training_intent: trainingIntent
      })
    })
    .then(response => response.json())
    .then(data => {
      // Hide loading spinner
      document.getElementById('loading-' + currentActivityId).style.display = 'none';

      if (data.error) {
        // Show error
        document.getElementById('analysis-content-' + currentActivityId).innerHTML =
          '<div class="alert alert-danger">' + data.error + '</div>';
        document.getElementById('analysis-' + currentActivityId).style.display = 'block';
      } else if (data.success) {
        // Show analysis results
        document.getElementById('analysis-content-' + currentActivityId).innerHTML = data.analysis_html;
        document.getElementById('analysis-' + currentActivityId).style.display = 'block';
      }
    })
    .catch(error => {
      // Hide loading spinner
      document.getElementById('loading-' + currentActivityId).style.display = 'none';
      // Show error
      document.getElementById('analysis-content-' + currentActivityId).innerHTML =
        '<div class="alert alert-danger">Error: ' + error.message + '</div>';
      document.getElementById('analysis-' + currentActivityId).style.display = 'block';
    });
  }

  window.addEventListener('DOMContentLoaded', function() {
    // No longer needed since we removed the "Analyze All Activities" button
  });
</script>
{% endblock %}
