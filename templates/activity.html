{% extends 'base.html' %}
{% block content %}
<h2>Activity Details</h2>
<a href="{{ url_for('index') }}" class="btn btn-link mb-3">&larr; Back to main page</a>
{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}
{% if activity %}
<div id="activity-preview">
  {% set activity_json = activity | tojson(indent=2) %}
  <pre class="bg-light p-3" id="activity-short">{{ activity_json[:400] }}{% if activity_json|length > 400 %}...
    <a href="#" id="show-all-link" onclick="document.getElementById('activity-short').style.display='none';document.getElementById('activity-full').style.display='block';return false;">Show all</a>{% endif %}</pre>
  <pre class="bg-light p-3" id="activity-full" style="display:none;">{{ activity_json }}
    <a href="#" onclick="document.getElementById('activity-full').style.display='none';document.getElementById('activity-short').style.display='block';return false;">Hide</a></pre>
</div>
<form method="post" id="analyze-form">
    <button type="submit" class="btn btn-success">Analyze with OpenAI</button>
</form>
{% endif %}
<div id="loading-spinner" style="display:none;" class="mt-3 text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div>Fetching response from OpenAI...</div>
</div>
<script>
  window.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('analyze-form');
    var spinner = document.getElementById('loading-spinner');
    if (form) {
      form.onsubmit = function() {
        form.style.display = 'none';
        spinner.style.display = 'block';
        return true;
      };
    }
    spinner.style.display = 'none';
  });
</script>
{% if analysis_html %}
<div class="mt-4">
    <h4>AI Analysis</h4>
    <div class="alert alert-info" style="white-space:normal;">{{ analysis_html|safe }}</div>
</div>
{% elif analysis %}
<div class="mt-4">
    <h4>AI Analysis</h4>
    <div class="alert alert-info" style="white-space:pre-line;">{{ analysis|e|replace('\n', '<br>')|safe }}</div>
</div>
{% endif %}
{% endblock %}
