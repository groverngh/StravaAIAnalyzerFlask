{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Select an Activity to Analyze{% if athlete_name %} - {{ athlete_name }}{% endif %}</h2>
    {% if athlete_name %}
        <a href="{{ url_for('athlete_profile', athlete_name=athlete_name) }}" class="btn btn-secondary">Back to Profile</a>
    {% else %}
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
    {% endif %}
</div>
<form method="post" action="{{ url_for('select_activity') }}" id="select-activity-form">
    <ul class="list-group mb-3">
        {% for act in activities %}
        <li class="list-group-item" id="activity-{{ act.id }}">
            <div class="d-flex justify-content-between align-items-center">
                <span>{{ act.name }} ({{ act.type }}, {{ act.distance_miles }} mi, {{ act.pace_min_per_mile }} min/mi)</span>
                <button type="button" class="btn btn-outline-primary btn-sm analyze-btn" data-activity-id="{{ act.id }}" onclick="analyzeActivity({{ act.id }}, this)">Analyze</button>
            </div>
            <div id="loading-{{ act.id }}" class="mt-2 text-center" style="display:none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <small class="ms-2">Fetching detailed data and analyzing with OpenAI...</small>
            </div>
            <div id="analysis-{{ act.id }}" class="mt-3 p-3 bg-light border rounded" style="display:none;">
                <h6>Analysis Results:</h6>
                <div id="analysis-content-{{ act.id }}"></div>
            </div>
        </li>
        {% endfor %}
    </ul>
    <div class="mb-3">
        <label for="analysis_query" class="form-label">What do you want to analyze? (optional)</label>
        <input type="text" class="form-control" id="analysis_query" name="analysis_query" value="{{ analysis_query or '' }}" placeholder="e.g. performance, heart rate, calories">
    </div>
    <button type="submit" class="btn btn-success" name="analyze_list" value="1">Analyze All Activities with OpenAI</button>
    <button type="submit" class="btn btn-info ms-2" name="summarize" value="1">Summarize Activities</button>
</form>
{% if summary %}
<h4 class="mt-4">Weekly Activity Summary</h4>
<table class="table table-bordered" id="summary-table">
    <thead>
        <tr>
            <th>Week Starting</th>
            {% for t in summary.activity_types %}
            <th>{{ t }}</th>
            {% endfor %}
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        {% for row in summary.rows %}
        <tr>
            <td>{{ row.week }}</td>
            {% for t in summary.activity_types %}
            <td>{{ row[t] }}</td>
            {% endfor %}
            <td>{{ row.total }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="mt-3">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
    <button class="btn btn-primary ms-2" onclick="downloadSummaryCSV(); return false;">Download CSV</button>
</div>
<script>
function downloadSummaryCSV() {
    var table = document.getElementById('summary-table');
    var rows = table.querySelectorAll('tr');
    var csv = [];
    for (var i = 0; i < rows.length; i++) {
        var cols = rows[i].querySelectorAll('th,td');
        var row = [];
        for (var j = 0; j < cols.length; j++) {
            row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
        }
        csv.push(row.join(','));
    }
    var csvContent = csv.join('\n');
    var blob = new Blob([csvContent], { type: 'text/csv' });
    var link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = 'strava_summary.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endif %}
<div id="loading-spinner" style="display:none;" class="mt-3 text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div>Fetching response from OpenAI...</div>
</div>
<script>
  function analyzeActivity(activityId, button) {
    // Show loading spinner
    document.getElementById('loading-' + activityId).style.display = 'block';
    // Hide analysis if previously shown
    document.getElementById('analysis-' + activityId).style.display = 'none';
    // Disable the analyze button
    button.disabled = true;
    button.innerText = 'Analyzing...';

    // Make AJAX request to analyze endpoint
    fetch('/api/analyze_activity/' + activityId, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Hide loading spinner
      document.getElementById('loading-' + activityId).style.display = 'none';
      // Re-enable button
      button.disabled = false;
      button.innerText = 'Analyze';

      if (data.error) {
        // Show error
        document.getElementById('analysis-content-' + activityId).innerHTML =
          '<div class="alert alert-danger">' + data.error + '</div>';
        document.getElementById('analysis-' + activityId).style.display = 'block';
      } else if (data.success) {
        // Show analysis results
        document.getElementById('analysis-content-' + activityId).innerHTML = data.analysis_html;
        document.getElementById('analysis-' + activityId).style.display = 'block';
      }
    })
    .catch(error => {
      // Hide loading spinner
      document.getElementById('loading-' + activityId).style.display = 'none';
      // Re-enable button
      button.disabled = false;
      button.innerText = 'Analyze';
      // Show error
      document.getElementById('analysis-content-' + activityId).innerHTML =
        '<div class="alert alert-danger">Error: ' + error.message + '</div>';
      document.getElementById('analysis-' + activityId).style.display = 'block';
    });
  }

  window.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('select-activity-form');
    var spinner = document.getElementById('loading-spinner');
    if (form) {
      form.addEventListener('submit', function(e) {
        // Only show spinner if the all-activity button is clicked
        var submitter = e.submitter || document.activeElement;
        if (submitter && submitter.name === 'analyze_list') {
          form.style.display = 'none';
          spinner.style.display = 'block';
        }
      });
    }
    spinner.style.display = 'none';
  });
</script>
{% endblock %}
